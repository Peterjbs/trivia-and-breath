<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia & Breath - The Ultimate Mindful Game</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --breath-inhale: #3b82f6;
            --breath-hold: #8b5cf6;
            --breath-exhale: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        /* Game Sections */
        .game-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .game-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============== TRIVIA SECTION ============== */
        .trivia-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .trivia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-display, .timer-display, .question-counter {
            background: var(--dark-bg);
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
        }

        .timer-display {
            background: linear-gradient(135deg, var(--warning-color), var(--danger-color));
        }

        .timer-display.warning {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-box {
            background: linear-gradient(135deg, var(--dark-bg), #2d3748);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .question-box h2 {
            font-size: 1.5rem;
            line-height: 1.6;
        }

        .category-badge {
            display: inline-block;
            background: var(--accent-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .answer-btn {
            padding: 20px;
            font-size: 1.1rem;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--dark-bg);
            color: var(--text-primary);
        }

        .answer-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
        }

        .answer-btn.correct {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .answer-btn.incorrect {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .trivia-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .control-btn.secondary {
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
        }

        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--dark-bg);
            color: var(--text-secondary);
        }

        .difficulty-btn.active {
            color: white;
        }

        .difficulty-btn.easy.active { background: var(--success-color); }
        .difficulty-btn.medium.active { background: var(--warning-color); }
        .difficulty-btn.hard.active { background: var(--danger-color); }

        /* Results Screen */
        .results-screen {
            text-align: center;
            padding: 40px;
        }

        .results-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .final-score {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--dark-bg);
            padding: 20px;
            border-radius: 15px;
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.8rem;
            font-weight: bold;
        }

        /* ============== BREATHING SECTION ============== */
        .breathing-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .breathing-pattern-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .pattern-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pattern-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .pattern-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: transparent;
        }

        .breathing-circle-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto 30px;
        }

        .breathing-circle-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            border: 3px solid rgba(99, 102, 241, 0.3);
        }

        .breathing-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--breath-inhale), var(--breath-hold));
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.5);
            transition: all 0.1s linear;
        }

        .breathing-circle.inhale {
            background: linear-gradient(135deg, var(--breath-inhale), #60a5fa);
            box-shadow: 0 0 60px rgba(59, 130, 246, 0.7);
        }

        .breathing-circle.hold {
            background: linear-gradient(135deg, var(--breath-hold), #a78bfa);
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.7);
        }

        .breathing-circle.exhale {
            background: linear-gradient(135deg, var(--breath-exhale), #22d3ee);
            box-shadow: 0 0 60px rgba(6, 182, 212, 0.7);
        }

        .breathing-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            z-index: 10;
        }

        .breathing-countdown {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .breathing-phase {
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .breathing-instructions {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .breathing-progress {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .progress-item {
            text-align: center;
        }

        .progress-item h4 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .progress-item p {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .breathing-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .breath-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--breath-inhale), var(--breath-hold));
            color: white;
        }

        .breath-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .breath-btn.stop {
            background: linear-gradient(135deg, var(--danger-color), #f87171);
        }

        .breath-btn.secondary {
            background: var(--card-bg);
            border: 2px solid var(--breath-inhale);
        }

        /* Session Duration Selector */
        .duration-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .duration-btn {
            padding: 8px 20px;
            border: 2px solid var(--accent-color);
            border-radius: 20px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .duration-btn.active {
            background: var(--accent-color);
        }

        /* Particle Effects */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            border-radius: 50%;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(99, 102, 241, 0.6);
            border-radius: 50%;
            animation: float 4s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }

        /* ============== COMBINED MODE ============== */
        .combined-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .combined-container {
                grid-template-columns: 1fr;
            }
        }

        .mini-breathing {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }

        .mini-circle-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 15px;
            position: relative;
        }

        .mini-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--breath-inhale), var(--breath-hold));
            transition: all 0.1s linear;
        }

        .mini-circle.inhale {
            background: linear-gradient(135deg, var(--breath-inhale), #60a5fa);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }

        .mini-circle.hold {
            background: linear-gradient(135deg, var(--breath-hold), #a78bfa);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }

        .mini-circle.exhale {
            background: linear-gradient(135deg, var(--breath-exhale), #22d3ee);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
        }

        /* Sound Toggle */
        .sound-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--dark-bg);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--success-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .breathing-circle-container {
                width: 250px;
                height: 250px;
            }

            .question-box h2 {
                font-size: 1.2rem;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: var(--success-color);
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Streak indicator */
        .streak-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .streak-flame {
            font-size: 1.5rem;
        }

        .streak-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üß† Trivia & Breath üå¨Ô∏è</h1>
            <p>Challenge your mind, calm your spirit</p>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('trivia')">üéØ Trivia Mode</button>
            <button class="mode-btn" onclick="setMode('breathing')">üå¨Ô∏è Breathing Mode</button>
            <button class="mode-btn" onclick="setMode('combined')">üéÆ Combined Mode</button>
        </div>

        <!-- Trivia Section -->
        <section id="trivia-section" class="game-section active">
            <div class="trivia-container">
                <!-- Pre-game setup -->
                <div id="trivia-setup">
                    <h2 style="text-align: center; margin-bottom: 20px;">Select Difficulty</h2>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn easy active" onclick="setDifficulty('easy')">Easy</button>
                        <button class="difficulty-btn medium" onclick="setDifficulty('medium')">Medium</button>
                        <button class="difficulty-btn hard" onclick="setDifficulty('hard')">Hard</button>
                    </div>
                    <div class="trivia-controls" style="margin-top: 20px;">
                        <button class="control-btn" onclick="startTrivia()">Start Game</button>
                    </div>
                </div>

                <!-- Active game -->
                <div id="trivia-game" style="display: none;">
                    <div class="trivia-header">
                        <div class="score-display">Score: <span id="score">0</span></div>
                        <div class="question-counter">Question <span id="current-q">1</span>/<span id="total-q">10</span></div>
                        <div class="timer-display" id="question-timer">‚è±Ô∏è <span id="timer">30</span>s</div>
                    </div>

                    <div class="streak-indicator" id="streak-indicator" style="display: none;">
                        <span class="streak-flame">üî•</span>
                        <span class="streak-count" id="streak-count">0</span>
                        <span>streak!</span>
                    </div>

                    <div class="question-box">
                        <span class="category-badge" id="category">General Knowledge</span>
                        <h2 id="question">Loading question...</h2>
                    </div>

                    <div class="answers-grid" id="answers">
                        <!-- Answers will be inserted here -->
                    </div>

                    <div class="trivia-controls">
                        <button class="control-btn secondary" onclick="skipQuestion()">Skip</button>
                        <button class="control-btn" onclick="useHint()">üí° Hint</button>
                    </div>
                </div>

                <!-- Results screen -->
                <div id="trivia-results" style="display: none;">
                    <div class="results-screen">
                        <h2>üéâ Game Complete!</h2>
                        <div class="final-score" id="final-score">0</div>
                        <p>points earned</p>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Correct</h3>
                                <p id="correct-count">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Incorrect</h3>
                                <p id="incorrect-count">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Best Streak</h3>
                                <p id="best-streak">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Avg Time</h3>
                                <p id="avg-time">0s</p>
                            </div>
                        </div>

                        <div class="trivia-controls">
                            <button class="control-btn" onclick="startTrivia()">Play Again</button>
                            <button class="control-btn secondary" onclick="setMode('breathing')">Take a Breath Break</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Breathing Section -->
        <section id="breathing-section" class="game-section">
            <div class="breathing-container">
                <h2 style="margin-bottom: 20px;">Choose Your Breathing Pattern</h2>
                
                <div class="breathing-pattern-selector">
                    <button class="pattern-btn active" onclick="setBreathPattern('478', this)">4-7-8 Relaxing</button>
                    <button class="pattern-btn" onclick="setBreathPattern('box', this)">Box Breathing</button>
                    <button class="pattern-btn" onclick="setBreathPattern('energize', this)">Energizing</button>
                    <button class="pattern-btn" onclick="setBreathPattern('calm', this)">Deep Calm</button>
                    <button class="pattern-btn" onclick="setBreathPattern('focus', this)">Focus</button>
                </div>

                <div class="duration-selector">
                    <button class="duration-btn" onclick="setDuration(60, this)">1 min</button>
                    <button class="duration-btn active" onclick="setDuration(180, this)">3 min</button>
                    <button class="duration-btn" onclick="setDuration(300, this)">5 min</button>
                    <button class="duration-btn" onclick="setDuration(600, this)">10 min</button>
                </div>

                <div class="sound-toggle">
                    <span>Sound Cues</span>
                    <div class="toggle-switch" id="sound-toggle" onclick="toggleSound()"></div>
                </div>

                <div class="breathing-circle-container">
                    <div class="breathing-circle-bg">
                        <div class="particles" id="particles"></div>
                    </div>
                    <div class="breathing-circle" id="breathing-circle"></div>
                    <div class="breathing-text" id="breathing-text">Ready</div>
                </div>

                <div class="breathing-countdown" id="breath-countdown">0:00</div>
                <div class="breathing-phase" id="breath-phase">Press Start</div>
                <p class="breathing-instructions" id="breath-instructions">Choose a pattern and duration, then press Start</p>

                <div class="breathing-progress">
                    <div class="progress-item">
                        <h4>Cycles</h4>
                        <p id="cycle-count">0</p>
                    </div>
                    <div class="progress-item">
                        <h4>Session Time</h4>
                        <p id="session-time">0:00</p>
                    </div>
                    <div class="progress-item">
                        <h4>Pattern</h4>
                        <p id="pattern-display">4-7-8</p>
                    </div>
                </div>

                <div class="breathing-controls">
                    <button class="breath-btn" id="breath-start-btn" onclick="toggleBreathing()">‚ñ∂ Start</button>
                    <button class="breath-btn secondary" onclick="resetBreathing()">‚Ü∫ Reset</button>
                </div>
            </div>
        </section>

        <!-- Combined Mode Section -->
        <section id="combined-section" class="game-section">
            <div class="combined-container">
                <div class="trivia-container" style="grid-column: span 1;">
                    <!-- Combined mode setup -->
                    <div id="combined-setup">
                        <h3 style="text-align: center; margin-bottom: 20px;">üéØ Mindful Trivia Challenge</h3>
                        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                            Complete breathing cycles, then answer trivia questions!<br>
                            Stay calm and focused for bonus points.
                        </p>
                        <div class="difficulty-selector" style="margin-bottom: 15px;">
                            <button class="difficulty-btn easy active" onclick="setCombinedDifficulty('easy', this)">Easy</button>
                            <button class="difficulty-btn medium" onclick="setCombinedDifficulty('medium', this)">Medium</button>
                            <button class="difficulty-btn hard" onclick="setCombinedDifficulty('hard', this)">Hard</button>
                        </div>
                        <div class="trivia-controls" style="margin-top: 20px;">
                            <button class="control-btn" onclick="startCombinedMode()">Start Combined Mode</button>
                        </div>
                    </div>
                    <!-- Combined mode active game -->
                    <div id="combined-game" style="display: none;">
                        <div class="trivia-header" style="margin-bottom: 15px;">
                            <div class="score-display">Score: <span id="combined-score">0</span></div>
                            <div class="question-counter">Round <span id="combined-round">1</span></div>
                        </div>
                        <div id="combined-breath-phase-display" style="text-align: center; margin-bottom: 15px;">
                            <span style="font-size: 1.2rem; color: var(--accent-color);" id="combined-phase-text">Breathing Phase</span>
                        </div>
                        <div class="question-box" id="combined-question-box" style="display: none;">
                            <span class="category-badge" id="combined-category">Category</span>
                            <h2 id="combined-question" style="font-size: 1.2rem;">Question</h2>
                        </div>
                        <div class="answers-grid" id="combined-answers" style="display: none;">
                            <!-- Answers inserted dynamically -->
                        </div>
                        <div class="trivia-controls" style="margin-top: 15px;">
                            <button class="control-btn secondary" id="combined-stop-btn" onclick="stopCombinedMode()">Stop</button>
                        </div>
                    </div>
                    <!-- Combined results -->
                    <div id="combined-results" style="display: none;">
                        <div class="results-screen" style="padding: 20px;">
                            <h2 style="font-size: 1.8rem;">üéâ Session Complete!</h2>
                            <div class="final-score" id="combined-final-score" style="font-size: 3rem;">0</div>
                            <p>points earned</p>
                            <div class="stats-grid" style="margin: 20px 0;">
                                <div class="stat-card">
                                    <h3>Rounds</h3>
                                    <p id="combined-rounds-completed">0</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Breath Cycles</h3>
                                    <p id="combined-breath-cycles">0</p>
                                </div>
                            </div>
                            <div class="trivia-controls">
                                <button class="control-btn" onclick="startCombinedMode()">Play Again</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mini-breathing">
                    <h3 style="margin-bottom: 15px;">üå¨Ô∏è Breath Sync</h3>
                    <div class="mini-circle-container">
                        <div class="breathing-circle-bg" style="width: 150px; height: 150px;"></div>
                        <div class="mini-circle" id="mini-breath-circle"></div>
                        <div class="breathing-text" id="mini-breath-text" style="font-size: 1rem;">Ready</div>
                    </div>
                    <p id="mini-breath-phase" style="font-size: 1.2rem; margin-bottom: 10px;">Ready</p>
                    <p id="mini-breath-timer" style="color: var(--text-secondary);">Cycles: <span id="mini-cycle-count">0</span></p>
                </div>
            </div>
        </section>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">Notification</div>

    <script>
        // ============== STATE MANAGEMENT ==============
        const state = {
            mode: 'trivia',
            // Trivia state
            triviaActive: false,
            currentQuestion: 0,
            score: 0,
            streak: 0,
            bestStreak: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            questionTimes: [],
            currentQuestionStartTime: 0,
            questions: [],
            difficulty: 'easy',
            questionTimer: null,
            timeLeft: 30,
            hintsUsed: 0,
            // Breathing state
            breathingActive: false,
            breathPattern: '478',
            sessionDuration: 180,
            cycles: 0,
            currentPhase: 'ready',
            phaseTime: 0,
            sessionStartTime: 0,
            breathInterval: null,
            soundEnabled: false,
            // Combined mode
            combinedActive: false,
            combinedPhase: 'breathing'
        };

        // ============== BREATHING PATTERNS ==============
        const breathPatterns = {
            '478': {
                name: '4-7-8 Relaxing',
                description: 'The classic relaxation technique',
                phases: [
                    { name: 'Inhale', duration: 4, instruction: 'Breathe in slowly through your nose' },
                    { name: 'Hold', duration: 7, instruction: 'Hold your breath gently' },
                    { name: 'Exhale', duration: 8, instruction: 'Exhale slowly through your mouth' }
                ]
            },
            'box': {
                name: 'Box Breathing',
                description: 'Navy SEAL technique for focus',
                phases: [
                    { name: 'Inhale', duration: 4, instruction: 'Breathe in steadily' },
                    { name: 'Hold', duration: 4, instruction: 'Hold at the top' },
                    { name: 'Exhale', duration: 4, instruction: 'Release slowly' },
                    { name: 'Hold', duration: 4, instruction: 'Hold at the bottom' }
                ]
            },
            'energize': {
                name: 'Energizing',
                description: 'Wake up and feel alert',
                phases: [
                    { name: 'Inhale', duration: 2, instruction: 'Quick breath in' },
                    { name: 'Hold', duration: 1, instruction: 'Brief hold' },
                    { name: 'Exhale', duration: 2, instruction: 'Quick breath out' }
                ]
            },
            'calm': {
                name: 'Deep Calm',
                description: 'For deep relaxation and sleep',
                phases: [
                    { name: 'Inhale', duration: 5, instruction: 'Deep breath in' },
                    { name: 'Hold', duration: 3, instruction: 'Gentle hold' },
                    { name: 'Exhale', duration: 7, instruction: 'Long, slow exhale' }
                ]
            },
            'focus': {
                name: 'Focus',
                description: 'Enhance concentration',
                phases: [
                    { name: 'Inhale', duration: 4, instruction: 'Steady breath in' },
                    { name: 'Hold', duration: 4, instruction: 'Hold with awareness' },
                    { name: 'Exhale', duration: 6, instruction: 'Controlled exhale' }
                ]
            }
        };

        // ============== TRIVIA QUESTIONS ==============
        const triviaQuestions = {
            easy: [
                { question: "What is the capital of France?", answers: ["Paris", "London", "Berlin", "Madrid"], correct: 0, category: "Geography" },
                { question: "How many days are in a week?", answers: ["5", "6", "7", "8"], correct: 2, category: "General" },
                { question: "What color is the sky on a clear day?", answers: ["Green", "Blue", "Red", "Yellow"], correct: 1, category: "Science" },
                { question: "What is 2 + 2?", answers: ["3", "4", "5", "6"], correct: 1, category: "Math" },
                { question: "Which animal says 'moo'?", answers: ["Dog", "Cat", "Cow", "Bird"], correct: 2, category: "Animals" },
                { question: "What is the largest ocean?", answers: ["Atlantic", "Pacific", "Indian", "Arctic"], correct: 1, category: "Geography" },
                { question: "How many legs does a spider have?", answers: ["6", "8", "10", "4"], correct: 1, category: "Animals" },
                { question: "What fruit is known for keeping doctors away?", answers: ["Banana", "Orange", "Apple", "Grape"], correct: 2, category: "Health" },
                { question: "What planet is known as the Red Planet?", answers: ["Venus", "Mars", "Jupiter", "Saturn"], correct: 1, category: "Space" },
                { question: "How many months have 31 days?", answers: ["5", "6", "7", "8"], correct: 2, category: "General" }
            ],
            medium: [
                { question: "What is the chemical symbol for gold?", answers: ["Ag", "Au", "Fe", "Cu"], correct: 1, category: "Science" },
                { question: "In what year did World War II end?", answers: ["1943", "1944", "1945", "1946"], correct: 2, category: "History" },
                { question: "What is the largest mammal?", answers: ["Elephant", "Blue Whale", "Giraffe", "Hippo"], correct: 1, category: "Animals" },
                { question: "Who painted the Mona Lisa?", answers: ["Van Gogh", "Picasso", "Da Vinci", "Michelangelo"], correct: 2, category: "Art" },
                { question: "What is the square root of 144?", answers: ["10", "11", "12", "14"], correct: 2, category: "Math" },
                { question: "Which country has the largest population?", answers: ["USA", "India", "China", "Russia"], correct: 2, category: "Geography" },
                { question: "What is the hardest natural substance?", answers: ["Gold", "Iron", "Diamond", "Platinum"], correct: 2, category: "Science" },
                { question: "How many strings does a standard guitar have?", answers: ["4", "5", "6", "8"], correct: 2, category: "Music" },
                { question: "What is the smallest prime number?", answers: ["0", "1", "2", "3"], correct: 2, category: "Math" },
                { question: "Which planet has the most moons?", answers: ["Jupiter", "Saturn", "Uranus", "Neptune"], correct: 1, category: "Space" }
            ],
            hard: [
                { question: "What is the atomic number of carbon?", answers: ["4", "6", "8", "12"], correct: 1, category: "Science" },
                { question: "In what year was the Treaty of Westphalia signed?", answers: ["1618", "1638", "1648", "1658"], correct: 2, category: "History" },
                { question: "What is the Fibonacci sequence's 10th number?", answers: ["34", "55", "89", "144"], correct: 1, category: "Math" },
                { question: "Which element has the symbol 'Sn'?", answers: ["Silver", "Tin", "Sodium", "Sulfur"], correct: 1, category: "Science" },
                { question: "What is the capital of Mongolia?", answers: ["Ulaanbaatar", "Astana", "Bishkek", "Dushanbe"], correct: 0, category: "Geography" },
                { question: "Who wrote 'The Canterbury Tales'?", answers: ["Shakespeare", "Chaucer", "Milton", "Dickens"], correct: 1, category: "Literature" },
                { question: "What is the speed of light in km/s (approx)?", answers: ["200,000", "300,000", "400,000", "500,000"], correct: 1, category: "Science" },
                { question: "In music, what does 'pianissimo' mean?", answers: ["Very loud", "Very soft", "Fast", "Slow"], correct: 1, category: "Music" },
                { question: "What year was the first iPhone released?", answers: ["2005", "2006", "2007", "2008"], correct: 2, category: "Technology" },
                { question: "What is the deepest point in the ocean?", answers: ["Mariana Trench", "Puerto Rico Trench", "Java Trench", "Philippine Trench"], correct: 0, category: "Geography" }
            ]
        };

        // ============== UTILITY FUNCTIONS ==============
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show' + (isError ? ' error' : '');
            setTimeout(() => notification.className = 'notification', 3000);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        }

        // ============== MODE MANAGEMENT ==============
        function setMode(mode) {
            state.mode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach((btn, index) => {
                btn.classList.remove('active');
                if ((mode === 'trivia' && index === 0) ||
                    (mode === 'breathing' && index === 1) ||
                    (mode === 'combined' && index === 2)) {
                    btn.classList.add('active');
                }
            });
            
            // Update sections
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(mode + '-section').classList.add('active');
            
            // Stop any active games when switching
            if (mode !== 'trivia' && state.triviaActive) {
                stopTrivia();
            }
            if (mode !== 'breathing' && state.breathingActive) {
                pauseBreathing();
            }
        }

        // ============== TRIVIA FUNCTIONS ==============
        function setDifficulty(difficulty) {
            state.difficulty = difficulty;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.difficulty-btn.' + difficulty).classList.add('active');
        }

        function startTrivia() {
            // Reset state
            state.triviaActive = true;
            state.currentQuestion = 0;
            state.score = 0;
            state.streak = 0;
            state.bestStreak = 0;
            state.correctAnswers = 0;
            state.incorrectAnswers = 0;
            state.questionTimes = [];
            state.hintsUsed = 0;
            
            // Get and shuffle questions
            state.questions = shuffleArray([...triviaQuestions[state.difficulty]]);
            
            // Show game view
            document.getElementById('trivia-setup').style.display = 'none';
            document.getElementById('trivia-game').style.display = 'block';
            document.getElementById('trivia-results').style.display = 'none';
            
            // Update UI
            document.getElementById('score').textContent = '0';
            document.getElementById('total-q').textContent = state.questions.length;
            
            loadQuestion();
        }

        function loadQuestion() {
            if (state.currentQuestion >= state.questions.length) {
                endTrivia();
                return;
            }
            
            const q = state.questions[state.currentQuestion];
            
            // Update UI
            document.getElementById('current-q').textContent = state.currentQuestion + 1;
            document.getElementById('category').textContent = q.category;
            document.getElementById('question').textContent = q.question;
            
            // Create shuffled answers with indices
            const answers = q.answers.map((answer, index) => ({ text: answer, originalIndex: index }));
            const shuffledAnswers = shuffleArray(answers);
            
            // Store correct answer index after shuffle
            const correctNewIndex = shuffledAnswers.findIndex(a => a.originalIndex === q.correct);
            state.questions[state.currentQuestion].shuffledCorrect = correctNewIndex;
            
            // Render answers
            const answersContainer = document.getElementById('answers');
            answersContainer.innerHTML = '';
            shuffledAnswers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = answer.text;
                btn.onclick = () => selectAnswer(index);
                answersContainer.appendChild(btn);
            });
            
            // Start timer
            state.timeLeft = state.difficulty === 'easy' ? 30 : state.difficulty === 'medium' ? 25 : 20;
            state.currentQuestionStartTime = Date.now();
            startQuestionTimer();
            
            // Update streak display
            updateStreakDisplay();
        }

        function startQuestionTimer() {
            clearInterval(state.questionTimer);
            updateTimerDisplay();
            
            state.questionTimer = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.questionTimer);
                    timeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('question-timer');
            document.getElementById('timer').textContent = state.timeLeft;
            
            if (state.timeLeft <= 5) {
                timerEl.classList.add('warning');
            } else {
                timerEl.classList.remove('warning');
            }
        }

        function selectAnswer(index) {
            clearInterval(state.questionTimer);
            
            const q = state.questions[state.currentQuestion];
            const isCorrect = index === q.shuffledCorrect;
            const timeTaken = (Date.now() - state.currentQuestionStartTime) / 1000;
            state.questionTimes.push(timeTaken);
            
            // Disable all buttons
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === q.shuffledCorrect) {
                    btn.classList.add('correct');
                } else if (i === index && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Update score and streak
            if (isCorrect) {
                const basePoints = state.difficulty === 'easy' ? 10 : state.difficulty === 'medium' ? 20 : 30;
                const timeBonus = Math.floor(state.timeLeft * 0.5);
                const streakBonus = state.streak * 5;
                state.score += basePoints + timeBonus + streakBonus;
                state.streak++;
                state.bestStreak = Math.max(state.bestStreak, state.streak);
                state.correctAnswers++;
                showNotification('Correct! +' + (basePoints + timeBonus + streakBonus) + ' points');
            } else {
                state.streak = 0;
                state.incorrectAnswers++;
                showNotification('Incorrect!', true);
            }
            
            document.getElementById('score').textContent = state.score;
            updateStreakDisplay();
            
            // Move to next question after delay
            setTimeout(() => {
                state.currentQuestion++;
                loadQuestion();
            }, 1500);
        }

        function timeUp() {
            state.streak = 0;
            state.incorrectAnswers++;
            
            const q = state.questions[state.currentQuestion];
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === q.shuffledCorrect) {
                    btn.classList.add('correct');
                }
            });
            
            showNotification("Time's up!", true);
            updateStreakDisplay();
            
            setTimeout(() => {
                state.currentQuestion++;
                loadQuestion();
            }, 1500);
        }

        function updateStreakDisplay() {
            const indicator = document.getElementById('streak-indicator');
            const count = document.getElementById('streak-count');
            
            if (state.streak >= 2) {
                indicator.style.display = 'flex';
                count.textContent = state.streak;
            } else {
                indicator.style.display = 'none';
            }
        }

        function skipQuestion() {
            clearInterval(state.questionTimer);
            state.incorrectAnswers++;
            state.streak = 0;
            state.currentQuestion++;
            loadQuestion();
        }

        function useHint() {
            if (state.hintsUsed >= 3) {
                showNotification('No more hints available!', true);
                return;
            }
            
            const q = state.questions[state.currentQuestion];
            const buttons = document.querySelectorAll('.answer-btn');
            let removed = 0;
            
            buttons.forEach((btn, i) => {
                if (i !== q.shuffledCorrect && !btn.disabled && removed < 2) {
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    removed++;
                }
            });
            
            state.hintsUsed++;
            showNotification('Hint used! (' + (3 - state.hintsUsed) + ' remaining)');
        }

        function stopTrivia() {
            clearInterval(state.questionTimer);
            state.triviaActive = false;
        }

        function endTrivia() {
            stopTrivia();
            
            // Show results
            document.getElementById('trivia-game').style.display = 'none';
            document.getElementById('trivia-results').style.display = 'block';
            
            // Update results
            document.getElementById('final-score').textContent = state.score;
            document.getElementById('correct-count').textContent = state.correctAnswers;
            document.getElementById('incorrect-count').textContent = state.incorrectAnswers;
            document.getElementById('best-streak').textContent = state.bestStreak;
            
            const avgTime = state.questionTimes.length > 0 
                ? (state.questionTimes.reduce((a, b) => a + b, 0) / state.questionTimes.length).toFixed(1)
                : 0;
            document.getElementById('avg-time').textContent = avgTime + 's';
        }

        // ============== BREATHING FUNCTIONS ==============
        function setBreathPattern(pattern, element) {
            state.breathPattern = pattern;
            
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            document.getElementById('pattern-display').textContent = breathPatterns[pattern].name;
            document.getElementById('breath-instructions').textContent = breathPatterns[pattern].description;
        }

        function setDuration(seconds, element) {
            state.sessionDuration = seconds;
            
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            const toggle = document.getElementById('sound-toggle');
            toggle.classList.toggle('active', state.soundEnabled);
        }

        function toggleBreathing() {
            if (state.breathingActive) {
                pauseBreathing();
            } else {
                startBreathing();
            }
        }

        function startBreathing() {
            state.breathingActive = true;
            state.sessionStartTime = Date.now();
            state.cycles = 0;
            state.currentPhase = 0;
            state.phaseTime = 0;
            
            document.getElementById('breath-start-btn').innerHTML = '‚è∏ Pause';
            document.getElementById('breath-start-btn').classList.add('stop');
            
            createParticles();
            runBreathingCycle();
        }

        function runBreathingCycle() {
            const pattern = breathPatterns[state.breathPattern];
            const phases = pattern.phases;
            let phaseIndex = 0;
            let countdown = phases[0].duration;
            
            updateBreathingUI(phases[0], countdown, phases[0].duration);
            
            state.breathInterval = setInterval(() => {
                if (!state.breathingActive) return;
                
                // Update session time
                const elapsed = Math.floor((Date.now() - state.sessionStartTime) / 1000);
                document.getElementById('session-time').textContent = formatTime(elapsed);
                
                const remaining = state.sessionDuration - elapsed;
                document.getElementById('breath-countdown').textContent = formatTime(Math.max(0, remaining));
                
                // Check if session is complete
                if (remaining <= 0) {
                    completeBreathingSession();
                    return;
                }
                
                countdown--;
                
                if (countdown <= 0) {
                    // Move to next phase
                    phaseIndex = (phaseIndex + 1) % phases.length;
                    
                    if (phaseIndex === 0) {
                        state.cycles++;
                        document.getElementById('cycle-count').textContent = state.cycles;
                    }
                    
                    countdown = phases[phaseIndex].duration;
                    
                    // Play sound if enabled
                    if (state.soundEnabled) {
                        playPhaseSound(phases[phaseIndex].name);
                    }
                }
                
                updateBreathingUI(phases[phaseIndex], countdown, phases[phaseIndex].duration);
                
            }, 1000);
        }

        function updateBreathingUI(phase, countdown, totalDuration) {
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            const phaseEl = document.getElementById('breath-phase');
            const instructionEl = document.getElementById('breath-instructions');
            
            // Update text
            text.textContent = countdown;
            phaseEl.textContent = phase.name;
            instructionEl.textContent = phase.instruction;
            
            // Update circle class
            circle.className = 'breathing-circle';
            if (phase.name === 'Inhale') {
                circle.classList.add('inhale');
            } else if (phase.name === 'Hold') {
                circle.classList.add('hold');
            } else if (phase.name === 'Exhale') {
                circle.classList.add('exhale');
            }
            
            // Calculate circle size based on phase progress
            const progress = 1 - (countdown / totalDuration);
            let size;
            
            if (phase.name === 'Inhale') {
                size = 80 + (progress * 180); // 80px to 260px
            } else if (phase.name === 'Exhale') {
                size = 260 - (progress * 180); // 260px to 80px
            } else {
                // Hold - maintain current size
                size = 260;
            }
            
            circle.style.width = size + 'px';
            circle.style.height = size + 'px';
        }

        function playPhaseSound(phaseName) {
            // Create audio context for sound cues
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                if (phaseName === 'Inhale') {
                    oscillator.frequency.value = 440; // A4
                } else if (phaseName === 'Hold') {
                    oscillator.frequency.value = 523; // C5
                } else {
                    oscillator.frequency.value = 392; // G4
                }
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch (e) {
                // Audio not supported
            }
        }

        function pauseBreathing() {
            state.breathingActive = false;
            clearInterval(state.breathInterval);
            
            document.getElementById('breath-start-btn').innerHTML = '‚ñ∂ Resume';
            document.getElementById('breath-start-btn').classList.remove('stop');
        }

        function resetBreathing() {
            state.breathingActive = false;
            clearInterval(state.breathInterval);
            
            state.cycles = 0;
            state.currentPhase = 0;
            
            document.getElementById('breath-start-btn').innerHTML = '‚ñ∂ Start';
            document.getElementById('breath-start-btn').classList.remove('stop');
            document.getElementById('breathing-circle').style.width = '80px';
            document.getElementById('breathing-circle').style.height = '80px';
            document.getElementById('breathing-circle').className = 'breathing-circle';
            document.getElementById('breathing-text').textContent = 'Ready';
            document.getElementById('breath-phase').textContent = 'Press Start';
            document.getElementById('breath-countdown').textContent = '0:00';
            document.getElementById('session-time').textContent = '0:00';
            document.getElementById('cycle-count').textContent = '0';
            document.getElementById('breath-instructions').textContent = 'Choose a pattern and duration, then press Start';
        }

        function completeBreathingSession() {
            pauseBreathing();
            showNotification('üéâ Breathing session complete! ' + state.cycles + ' cycles finished');
            
            document.getElementById('breath-phase').textContent = 'Complete!';
            document.getElementById('breathing-text').textContent = '‚úì';
        }

        function createParticles() {
            const container = document.getElementById('particles');
            container.innerHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 4 + 's';
                container.appendChild(particle);
            }
        }

        // ============== COMBINED MODE ==============
        function setCombinedDifficulty(difficulty, element) {
            state.difficulty = difficulty;
            document.querySelectorAll('#combined-setup .difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
        }

        function startCombinedMode() {
            // Reset combined mode state
            state.combinedActive = true;
            state.combinedPhase = 'breathing';
            state.combinedRound = 1;
            state.combinedScore = 0;
            state.combinedBreathCycles = 0;
            state.combinedQuestions = shuffleArray([...triviaQuestions[state.difficulty]]);
            state.combinedQuestionIndex = 0;
            
            // Show game view
            document.getElementById('combined-setup').style.display = 'none';
            document.getElementById('combined-game').style.display = 'block';
            document.getElementById('combined-results').style.display = 'none';
            
            // Update UI
            document.getElementById('combined-score').textContent = '0';
            document.getElementById('combined-round').textContent = '1';
            document.getElementById('mini-cycle-count').textContent = '0';
            
            showNotification('Combined mode starting! Breathe first, then answer.');
            
            // Start breathing phase
            startCombinedBreathing();
        }

        function startCombinedBreathing() {
            state.combinedPhase = 'breathing';
            document.getElementById('combined-phase-text').textContent = 'üå¨Ô∏è Breathing Phase - Complete 2 cycles';
            document.getElementById('combined-question-box').style.display = 'none';
            document.getElementById('combined-answers').style.display = 'none';
            
            // Start mini breathing animation
            const pattern = breathPatterns['box']; // Use box breathing for combined mode
            let phaseIndex = 0;
            let countdown = pattern.phases[0].duration;
            let cyclesInRound = 0;
            
            updateMiniBreathingUI(pattern.phases[0], countdown, pattern.phases[0].duration);
            
            state.combinedBreathInterval = setInterval(() => {
                if (!state.combinedActive) {
                    clearInterval(state.combinedBreathInterval);
                    return;
                }
                
                countdown--;
                
                if (countdown <= 0) {
                    phaseIndex = (phaseIndex + 1) % pattern.phases.length;
                    
                    if (phaseIndex === 0) {
                        cyclesInRound++;
                        state.combinedBreathCycles++;
                        document.getElementById('mini-cycle-count').textContent = state.combinedBreathCycles;
                        
                        // After 2 cycles, switch to trivia
                        if (cyclesInRound >= 2) {
                            clearInterval(state.combinedBreathInterval);
                            startCombinedTrivia();
                            return;
                        }
                    }
                    
                    countdown = pattern.phases[phaseIndex].duration;
                }
                
                updateMiniBreathingUI(pattern.phases[phaseIndex], countdown, pattern.phases[phaseIndex].duration);
                
            }, 1000);
        }

        function updateMiniBreathingUI(phase, countdown, totalDuration) {
            const circle = document.getElementById('mini-breath-circle');
            const text = document.getElementById('mini-breath-text');
            const phaseEl = document.getElementById('mini-breath-phase');
            
            // Update text
            text.textContent = countdown;
            phaseEl.textContent = phase.name;
            
            // Update circle class
            circle.className = 'mini-circle';
            if (phase.name === 'Inhale') {
                circle.classList.add('inhale');
            } else if (phase.name === 'Hold') {
                circle.classList.add('hold');
            } else if (phase.name === 'Exhale') {
                circle.classList.add('exhale');
            }
            
            // Calculate circle size
            const progress = 1 - (countdown / totalDuration);
            let size;
            
            if (phase.name === 'Inhale') {
                size = 40 + (progress * 70); // 40px to 110px
            } else if (phase.name === 'Exhale') {
                size = 110 - (progress * 70); // 110px to 40px
            } else {
                size = phase.name === 'Hold' && progress === 0 ? 110 : 40;
            }
            
            circle.style.width = size + 'px';
            circle.style.height = size + 'px';
        }

        function startCombinedTrivia() {
            state.combinedPhase = 'trivia';
            document.getElementById('combined-phase-text').textContent = 'üéØ Trivia Phase - Answer the question!';
            
            if (state.combinedQuestionIndex >= state.combinedQuestions.length) {
                state.combinedQuestionIndex = 0;
                state.combinedQuestions = shuffleArray([...triviaQuestions[state.difficulty]]);
            }
            
            const q = state.combinedQuestions[state.combinedQuestionIndex];
            
            // Show question
            document.getElementById('combined-question-box').style.display = 'block';
            document.getElementById('combined-answers').style.display = 'grid';
            document.getElementById('combined-category').textContent = q.category;
            document.getElementById('combined-question').textContent = q.question;
            
            // Create shuffled answers
            const answers = q.answers.map((answer, index) => ({ text: answer, originalIndex: index }));
            const shuffledAnswers = shuffleArray(answers);
            const correctNewIndex = shuffledAnswers.findIndex(a => a.originalIndex === q.correct);
            state.combinedQuestions[state.combinedQuestionIndex].shuffledCorrect = correctNewIndex;
            
            // Render answers
            const answersContainer = document.getElementById('combined-answers');
            answersContainer.innerHTML = '';
            shuffledAnswers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = answer.text;
                btn.onclick = () => selectCombinedAnswer(index);
                answersContainer.appendChild(btn);
            });
        }

        function selectCombinedAnswer(index) {
            const q = state.combinedQuestions[state.combinedQuestionIndex];
            const isCorrect = index === q.shuffledCorrect;
            
            // Disable all buttons
            const buttons = document.querySelectorAll('#combined-answers .answer-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === q.shuffledCorrect) {
                    btn.classList.add('correct');
                } else if (i === index && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Update score
            if (isCorrect) {
                const points = state.difficulty === 'easy' ? 15 : state.difficulty === 'medium' ? 25 : 40;
                state.combinedScore += points;
                document.getElementById('combined-score').textContent = state.combinedScore;
                showNotification('Correct! +' + points + ' points (calm bonus!)');
            } else {
                showNotification('Incorrect!', true);
            }
            
            state.combinedQuestionIndex++;
            state.combinedRound++;
            
            // Check if we should continue or end
            if (state.combinedRound > 5) {
                setTimeout(() => endCombinedMode(), 1500);
            } else {
                document.getElementById('combined-round').textContent = state.combinedRound;
                setTimeout(() => startCombinedBreathing(), 1500);
            }
        }

        function stopCombinedMode() {
            state.combinedActive = false;
            clearInterval(state.combinedBreathInterval);
            endCombinedMode();
        }

        function endCombinedMode() {
            state.combinedActive = false;
            clearInterval(state.combinedBreathInterval);
            
            // Show results
            document.getElementById('combined-game').style.display = 'none';
            document.getElementById('combined-results').style.display = 'block';
            
            document.getElementById('combined-final-score').textContent = state.combinedScore;
            document.getElementById('combined-rounds-completed').textContent = state.combinedRound - 1;
            document.getElementById('combined-breath-cycles').textContent = state.combinedBreathCycles;
            
            showNotification('üéâ Combined session complete!');
        }

        // ============== INITIALIZATION ==============
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
        });
    </script>
</body>
</html>
